---
import { getCollection, render } from 'astro:content';
import PageLayout from '../../layouts/PageLayout.astro';
import Section from '../../components/shared/Section.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { id: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const { title, description, date, category, author, image } = post.data;

const formattedDate = new Date(date).toLocaleDateString('en-GB', {
  day: 'numeric',
  month: 'long',
  year: 'numeric',
});

const wordCount = post.body ? post.body.split(/\s+/).length : 0;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));
---

<PageLayout title={title} description={description} ogImage={image} article>
  <Section>
    <article class="max-w-3xl mx-auto">
      <!-- Header -->
      <header class="mb-10 reveal">
        {category && (
          <span class="inline-block text-sm font-semibold text-(--color-brand) bg-(--color-brand)/10 px-3 py-1 rounded-full mb-4">
            {category}
          </span>
        )}
        <h1 class="font-(family-name:--font-heading) text-3xl sm:text-4xl lg:text-5xl font-extrabold text-(--color-text-primary) mb-4 leading-tight">
          {title}
        </h1>
        <div class="flex flex-wrap items-center gap-4 text-sm text-(--color-text-secondary)">
          <span>{author}</span>
          <span>&middot;</span>
          <time datetime={new Date(date).toISOString()}>{formattedDate}</time>
          <span>&middot;</span>
          <span>{readingTime} min read</span>
        </div>
      </header>

      <!-- Content -->
      <div class="prose reveal">
        <Content />
      </div>

      <!-- Back link -->
      <div class="mt-12 pt-8 border-t border-(--color-bg-secondary) reveal">
        <a href="/blog" class="text-(--color-brand) hover:text-(--color-brand-hover) font-semibold transition-colors">
          &larr; Back to Blog
        </a>
      </div>
    </article>
  </Section>

  <!-- Article JSON-LD -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": title,
    "description": description,
    "author": {
      "@type": "Person",
      "name": author,
    },
    "datePublished": new Date(date).toISOString(),
    "publisher": {
      "@type": "Organization",
      "name": "DannStarr Electronics",
      "url": "https://dannstarr.co.uk",
    },
  })} />
</PageLayout>
